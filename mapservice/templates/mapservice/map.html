{% extends "blog/base.html" %}
{% load static %}
{% load leaflet_tags %}

{% block extra_css %}
    {% leaflet_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'mapservice/mapcss.css' %}"/>
{% endblock extra_css %}

{% block content %}

    <center>
        <div id="map">
            {% leaflet_map "map_studenteats" callback="window.setupMap" %}
        </div>
    </center>
    

    {%  if show_posts %}
    {% include 'blog/block/list-posts.html'  %}
    {% endif %}

    {% block extra_jss %}
        {% leaflet_js %}

        <!-- Marker Icons from https://github.com/pointhi/leaflet-color-markers-->
        <script>
            function setupMap(map) {
                let redMarkerUrl = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
                let greenMarkerUrl = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png';

                function putOnMap(descr, latAndLong, markerUrl, name, address) {
                    if(name != undefined)
                        descr = '<a href="' + '{% url 'blog-map' %}' + '/' + name + '/' + address +'">' + descr + '</a>';

                    let iconMarker = new L.Icon({
                        iconUrl: markerUrl,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                        });
                    let marker = L.marker(latAndLong, {icon: iconMarker}).addTo(map);
                    marker.bindPopup(descr);
                    marker.on('mouseover', (e) => {marker.openPopup()});
                }

                map.locate({setView: true});
                map.on('locationfound', (e) => {putOnMap("Your current position (approximation)", e.latlng, greenMarkerUrl)});
                map.on('locationerror', (e) => {alert("Enable geolocalisation to see the eating places near your location ;-)")});

	            {% for resto in restaurants %}
                    putOnMap("{{resto.name}}" + " - " + "{{resto.address}}", [{{resto.latitude}}, {{resto.longitude}}], redMarkerUrl, "{{resto.name}}", "{{resto.address}}");
	            {% endfor %}
            }
        </script>
    {% endblock extra_jss %}
{% endblock content %}
